name: Blue/Green Deploy to Production

# ============================================================
# How it works:
#   1. Determines the currently INACTIVE slot (blue or green)
#   2. Deploys the new image to the inactive slot
#   3. Waits for all pods in the new slot to be Ready
#   4. Switches the service selectors to point to the new slot
#      (zero-downtime cutover — existing connections drain first)
#   5. On rollback: re-patches selectors back to the previous slot
# ============================================================

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (short SHA)"
        required: true
        type: string
      action:
        description: "Action to perform"
        required: true
        type: choice
        options:
          - deploy-and-switch    # Deploy to inactive slot, then switch traffic
          - switch-only          # Switch traffic without deploying (manual slot flip)
          - rollback             # Switch traffic back to the previous slot
      confirm:
        description: "Type 'confirm' to proceed with production change"
        required: true
        type: string

env:
  ACR_LOGIN_SERVER: netflixappprodacr.azurecr.io
  AKS_CLUSTER_NAME: netflix-app-prod-aks
  AKS_RESOURCE_GROUP: netflix-app-prod-rg
  NAMESPACE: netflix-prod

permissions:
  id-token: write
  contents: read

jobs:
  # -------------------------------------------------------
  # Gate: require explicit confirmation
  # -------------------------------------------------------
  validate:
    name: Validate Request
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: github.event.inputs.confirm != 'confirm'
        run: |
          echo "::error::You must type 'confirm' to proceed."
          exit 1

  # -------------------------------------------------------
  # Blue/Green Operation
  # -------------------------------------------------------
  blue-green:
    name: Blue/Green (${{ github.event.inputs.action }})
    runs-on: ubuntu-latest
    needs: validate
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AKS_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      # -------------------------------------------------------
      # Detect active and inactive slots
      # -------------------------------------------------------
      - name: Detect active slot
        id: slots
        run: |
          ACTIVE=$(kubectl get service netflix-web-service \
            -n ${{ env.NAMESPACE }} \
            -o jsonpath='{.spec.selector.slot}' 2>/dev/null || echo "blue")

          if [ "$ACTIVE" = "blue" ]; then
            INACTIVE="green"
          else
            INACTIVE="blue"
          fi

          echo "active=$ACTIVE"     >> $GITHUB_OUTPUT
          echo "inactive=$INACTIVE" >> $GITHUB_OUTPUT
          echo "Active slot:   $ACTIVE"
          echo "Inactive slot: $INACTIVE"

      # -------------------------------------------------------
      # Deploy new image to inactive slot
      # -------------------------------------------------------
      - name: Deploy to inactive slot (${{ steps.slots.outputs.inactive }})
        if: github.event.inputs.action == 'deploy-and-switch'
        run: |
          IMAGE_TAG=${{ github.event.inputs.image_tag }}
          SLOT=${{ steps.slots.outputs.inactive }}

          sed -e "s|__ACR_LOGIN_SERVER__|${{ env.ACR_LOGIN_SERVER }}|g" \
              -e "s|__IMAGE_TAG__|${IMAGE_TAG}|g" \
              k8s/prod/blue-green/deployment-${SLOT}.yml | kubectl apply -f -

          echo "Deployed image tag ${IMAGE_TAG} to ${SLOT} slot."

      - name: Wait for inactive slot to be Ready
        if: github.event.inputs.action == 'deploy-and-switch'
        run: |
          SLOT=${{ steps.slots.outputs.inactive }}

          kubectl rollout status deployment/netflix-web-${SLOT} \
            -n ${{ env.NAMESPACE }} --timeout=600s
          kubectl rollout status deployment/netflix-api-${SLOT} \
            -n ${{ env.NAMESPACE }} --timeout=600s

          echo "All pods in ${SLOT} slot are Ready."

      # -------------------------------------------------------
      # Switch traffic to the target slot
      # -------------------------------------------------------
      - name: Switch traffic to ${{ steps.slots.outputs.inactive }}
        if: github.event.inputs.action == 'deploy-and-switch' || github.event.inputs.action == 'switch-only'
        run: |
          TARGET=${{ steps.slots.outputs.inactive }}

          # Patch web service
          kubectl patch service netflix-web-service \
            -n ${{ env.NAMESPACE }} \
            --type=merge \
            -p "{\"spec\":{\"selector\":{\"app\":\"netflix-web\",\"slot\":\"${TARGET}\"}},\"metadata\":{\"annotations\":{\"blue-green/active-slot\":\"${TARGET}\"}}}"

          # Patch API service
          kubectl patch service netflix-api-service \
            -n ${{ env.NAMESPACE }} \
            --type=merge \
            -p "{\"spec\":{\"selector\":{\"app\":\"netflix-api\",\"slot\":\"${TARGET}\"}},\"metadata\":{\"annotations\":{\"blue-green/active-slot\":\"${TARGET}\"}}}"

          echo "Traffic switched to ${TARGET} slot."
          echo "Previous active slot (${{ steps.slots.outputs.active }}) is now idle — available for rollback."

      # -------------------------------------------------------
      # Rollback: switch back to the currently active (old) slot
      # -------------------------------------------------------
      - name: Rollback to ${{ steps.slots.outputs.active }}
        if: github.event.inputs.action == 'rollback'
        run: |
          # On rollback the "active" slot IS the old stable slot we want to restore
          # and "inactive" is the broken new slot we want to abandon.
          # We simply switch selectors back to "active".
          TARGET=${{ steps.slots.outputs.active }}

          kubectl patch service netflix-web-service \
            -n ${{ env.NAMESPACE }} \
            --type=merge \
            -p "{\"spec\":{\"selector\":{\"app\":\"netflix-web\",\"slot\":\"${TARGET}\"}},\"metadata\":{\"annotations\":{\"blue-green/active-slot\":\"${TARGET}\"}}}"

          kubectl patch service netflix-api-service \
            -n ${{ env.NAMESPACE }} \
            --type=merge \
            -p "{\"spec\":{\"selector\":{\"app\":\"netflix-api\",\"slot\":\"${TARGET}\"}},\"metadata\":{\"annotations\":{\"blue-green/active-slot\":\"${TARGET}\"}}}"

          echo "::warning::Rolled back. Traffic is now on ${TARGET} slot."

      # -------------------------------------------------------
      # Verification
      # -------------------------------------------------------
      - name: Verify deployment state
        run: |
          echo "=== Active Slot ==="
          kubectl get service netflix-web-service -n ${{ env.NAMESPACE }} \
            -o jsonpath='Web slot: {.spec.selector.slot}{"\n"}'
          kubectl get service netflix-api-service -n ${{ env.NAMESPACE }} \
            -o jsonpath='API slot: {.spec.selector.slot}{"\n"}'
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n ${{ env.NAMESPACE }} \
            -l app=netflix-web --show-labels
          kubectl get pods -n ${{ env.NAMESPACE }} \
            -l app=netflix-api --show-labels

  # -------------------------------------------------------
  # Notification
  # -------------------------------------------------------
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: blue-green
    if: always()
    steps:
      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "${{ needs.blue-green.result == 'success' && '✅' || '❌' }} Blue/Green ${{ github.event.inputs.action }} - Netflix Production"
          to: ${{ secrets.SMTP_USERNAME }}
          from: Netflix CI/CD <${{ secrets.SMTP_USERNAME }}>
          body: |
            Blue/Green Deployment ${{ needs.blue-green.result == 'success' && 'Succeeded' || 'FAILED' }}

            Action:    ${{ github.event.inputs.action }}
            Image Tag: ${{ github.event.inputs.image_tag }}
            Actor:     ${{ github.actor }}

            Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
