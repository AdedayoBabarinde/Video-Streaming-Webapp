name: OWASP ZAP - DAST Security Scan

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "Target URL to scan (e.g., http://<INGRESS_IP>)"
        required: true
        type: string
      scan_type:
        description: "Type of ZAP scan"
        required: true
        type: choice
        options:
          - baseline
          - full
  # Also run after successful prod deployment
  workflow_run:
    workflows: ["Deploy to Production"]
    types: [completed]

permissions:
  id-token: write
  contents: read
  issues: write

env:
  AKS_CLUSTER_NAME: netflix-app-prod-aks
  AKS_RESOURCE_GROUP: netflix-app-prod-rg
  NAMESPACE: netflix-prod

jobs:
  # -------------------------------------------------------
  # Job 1: Resolve target URL
  # -------------------------------------------------------
  resolve-target:
    name: Resolve Scan Target
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      target_url: ${{ steps.resolve.outputs.url }}
      scan_type: ${{ steps.resolve.outputs.scan_type }}
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve target URL
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "url=${{ inputs.target_url }}" >> $GITHUB_OUTPUT
            echo "scan_type=${{ inputs.scan_type }}" >> $GITHUB_OUTPUT
          else
            # Auto-triggered after prod deploy - get ingress IP
            az aks get-credentials \
              --resource-group ${{ env.AKS_RESOURCE_GROUP }} \
              --name ${{ env.AKS_CLUSTER_NAME }} \
              --overwrite-existing

            INGRESS_IP=$(kubectl get ingress netflix-ingress -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null)

            if [ -z "$INGRESS_IP" ]; then
              echo "::warning::No Ingress IP found. Skipping DAST scan."
              echo "url=" >> $GITHUB_OUTPUT
            else
              echo "url=http://${INGRESS_IP}" >> $GITHUB_OUTPUT
            fi
            echo "scan_type=baseline" >> $GITHUB_OUTPUT
          fi

  # -------------------------------------------------------
  # Job 2: OWASP ZAP Baseline Scan
  # -------------------------------------------------------
  zap-baseline:
    name: ZAP Baseline Scan
    runs-on: ubuntu-latest
    needs: resolve-target
    if: needs.resolve-target.outputs.target_url != '' && needs.resolve-target.outputs.scan_type == 'baseline'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ needs.resolve-target.outputs.target_url }}
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a -j"
          allow_issue_writing: true
          fail_action: false
          artifact_name: "zap-baseline-report"

  # -------------------------------------------------------
  # Job 3: OWASP ZAP Full Scan
  # -------------------------------------------------------
  zap-full:
    name: ZAP Full Scan
    runs-on: ubuntu-latest
    needs: resolve-target
    if: needs.resolve-target.outputs.target_url != '' && needs.resolve-target.outputs.scan_type == 'full'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: ${{ needs.resolve-target.outputs.target_url }}
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-a -j"
          allow_issue_writing: true
          fail_action: false
          artifact_name: "zap-full-report"

  # -------------------------------------------------------
  # Job 4: Scan API endpoints
  # -------------------------------------------------------
  zap-api:
    name: ZAP API Scan
    runs-on: ubuntu-latest
    needs: resolve-target
    if: needs.resolve-target.outputs.target_url != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: OWASP ZAP API Scan
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: "${{ needs.resolve-target.outputs.target_url }}/api/"
          format: openapi
          cmd_options: "-a -j"
          allow_issue_writing: true
          fail_action: false
          artifact_name: "zap-api-report"
