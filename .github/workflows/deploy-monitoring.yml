name: Deploy Monitoring Stack

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - prod

env:
  AKS_CLUSTER_NAME_DEV: netflix-app-dev-aks
  AKS_RESOURCE_GROUP_DEV: netflix-app-dev-rg
  AKS_CLUSTER_NAME_PROD: netflix-app-prod-aks
  AKS_RESOURCE_GROUP_PROD: netflix-app-prod-rg
  MONITORING_NAMESPACE: monitoring

permissions:
  id-token: write
  contents: read

jobs:
  deploy-monitoring:
    name: Deploy kube-prometheus-stack via Helm
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set cluster variables
        id: cluster
        run: |
          if [ "${{ inputs.environment }}" = "prod" ]; then
            echo "cluster_name=${{ env.AKS_CLUSTER_NAME_PROD }}" >> $GITHUB_OUTPUT
            echo "resource_group=${{ env.AKS_RESOURCE_GROUP_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "cluster_name=${{ env.AKS_CLUSTER_NAME_DEV }}" >> $GITHUB_OUTPUT
            echo "resource_group=${{ env.AKS_RESOURCE_GROUP_DEV }}" >> $GITHUB_OUTPUT
          fi

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ steps.cluster.outputs.resource_group }} \
            --name ${{ steps.cluster.outputs.cluster_name }} \
            --overwrite-existing

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Create monitoring namespace
        run: |
          kubectl create namespace ${{ env.MONITORING_NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Add Prometheus Community Helm repo
        run: |
          helm repo add prometheus-community \
            https://prometheus-community.github.io/helm-charts
          helm repo update

      - name: Deploy kube-prometheus-stack
        run: |
          helm upgrade --install kube-prometheus-stack \
            prometheus-community/kube-prometheus-stack \
            --namespace ${{ env.MONITORING_NAMESPACE }} \
            --values k8s/monitoring/helm-values.yml \
            --set grafana.adminPassword=${{ secrets.GRAFANA_ADMIN_PASSWORD }} \
            --atomic \
            --timeout 10m \
            --cleanup-on-fail

      - name: Deploy Netflix custom dashboard ConfigMap
        run: |
          kubectl apply -f k8s/monitoring/netflix-dashboard-cm.yml

      - name: Wait for rollouts
        run: |
          kubectl rollout status deployment/kube-prometheus-stack-grafana \
            -n ${{ env.MONITORING_NAMESPACE }} --timeout=300s
          kubectl rollout status statefulset/prometheus-kube-prometheus-stack-prometheus \
            -n ${{ env.MONITORING_NAMESPACE }} --timeout=300s

      - name: Display monitoring endpoints
        run: |
          echo "=== Monitoring Stack Status ==="
          kubectl get pods -n ${{ env.MONITORING_NAMESPACE }}
          echo ""
          echo "=== Services ==="
          kubectl get svc -n ${{ env.MONITORING_NAMESPACE }}
          echo ""
          GRAFANA_IP=$(kubectl get svc kube-prometheus-stack-grafana \
            -n ${{ env.MONITORING_NAMESPACE }} \
            -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
          echo "Grafana: http://${GRAFANA_IP} (admin / your configured password)"
          echo "Login, then navigate to: Dashboards â†’ Netflix Streaming App"
