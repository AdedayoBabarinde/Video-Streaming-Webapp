name: Deploy to Dev

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  ACR_NAME: netflixappdevacr
  ACR_LOGIN_SERVER: netflixappdevacr.azurecr.io
  AKS_CLUSTER_NAME: netflix-app-dev-aks
  AKS_RESOURCE_GROUP: netflix-app-dev-rg
  NAMESPACE: netflix-dev
  FRONTEND_IMAGE: netflix-app
  API_IMAGE: netflix-api

permissions:
  id-token: write
  contents: read

jobs:
  # -------------------------------------------------------
  # Job 1: Build and Push Docker Images to ACR
  # -------------------------------------------------------
  build-and-push:
    name: Build & Push to ACR
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate image tag
        id: meta
        run: echo "tags=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      # Build and push frontend image
      - name: Build and push frontend image
        working-directory: ./app
        run: |
          docker build -f Dockerfile.frontend \
            --build-arg VITE_APP_TMDB_V3_API_KEY=${{ secrets.TMDB_API_KEY }} \
            -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.tags }} \
            -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE }}:latest \
            .
          docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.tags }}
          docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE }}:latest

      # Build and push API image
      - name: Build and push API image
        working-directory: ./app
        run: |
          docker build -f Dockerfile \
            -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.API_IMAGE }}:${{ steps.meta.outputs.tags }} \
            -t ${{ env.ACR_LOGIN_SERVER }}/${{ env.API_IMAGE }}:latest \
            .
          docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.API_IMAGE }}:${{ steps.meta.outputs.tags }}
          docker push ${{ env.ACR_LOGIN_SERVER }}/${{ env.API_IMAGE }}:latest

      # Trivy scan on the built images
      - name: Trivy scan frontend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.tags }}"
          format: "table"
          exit-code: "0"
          severity: "CRITICAL,HIGH"

      - name: Trivy scan API image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ env.ACR_LOGIN_SERVER }}/${{ env.API_IMAGE }}:${{ steps.meta.outputs.tags }}"
          format: "table"
          exit-code: "0"
          severity: "CRITICAL,HIGH"

  # -------------------------------------------------------
  # Job 2: Deploy to Dev AKS
  # -------------------------------------------------------
  deploy-dev:
    name: Deploy to Dev AKS
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ env.AKS_RESOURCE_GROUP }} \
            --name ${{ env.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Create namespace if not exists
        run: kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create/Update secrets
        run: |
          kubectl create secret generic netflix-app-secrets \
            --namespace=${{ env.NAMESPACE }} \
            --from-literal=TMDB_API_KEY=${{ secrets.TMDB_API_KEY }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply ConfigMap
        run: |
          kubectl apply -f k8s/base/configmap.yml -n ${{ env.NAMESPACE }}

      - name: Deploy to Dev
        run: |
          IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}

          # Replace placeholders in deployment manifests
          sed -e "s|__ACR_LOGIN_SERVER__|${{ env.ACR_LOGIN_SERVER }}|g" \
              -e "s|__IMAGE_TAG__|${IMAGE_TAG}|g" \
              k8s/dev/deployment.yml | kubectl apply -f -

          kubectl apply -f k8s/dev/service.yml
          kubectl apply -f k8s/dev/ingress.yml
          kubectl apply -f k8s/dev/hpa.yml

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/netflix-web -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl rollout status deployment/netflix-api -n ${{ env.NAMESPACE }} --timeout=300s

      - name: Verify deployment
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployments -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Services ==="
          kubectl get services -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n ${{ env.NAMESPACE }}
